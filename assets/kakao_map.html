<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="initial-scale=1, width=device-width"/>

  <!-- CSP: Kakao/Daum CDN 허용 -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' data: blob: https://dapi.kakao.com https://*.kakao.com https://t1.daumcdn.net;
                 script-src  'self' 'unsafe-inline' 'unsafe-eval' https://dapi.kakao.com https://t1.daumcdn.net;
                 style-src   'self' 'unsafe-inline' https://t1.daumcdn.net;
                 img-src     * data: blob:;
                 connect-src * data: blob:;">

  <style>
    html,body,#map{height:100%;margin:0;padding:0}
    .cluster-badge{background:#3F51B5;color:#fff;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px;box-shadow:0 2px 6px rgba(0,0,0,.25);transform:translate(-50%,-50%);white-space:nowrap}
    .avatar{width:36px;height:36px;border-radius:999px;overflow:hidden;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25);transform:translate(-50%,-50%);background:#eee}
    .avatar img{width:100%;height:100%;object-fit:cover}
  </style>

  <!-- autoload=false 로드 후 kakao.maps.load 콜백에서 초기화 -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=2290e93721901059327d444c07d7faa4&autoload=false"></script>
</head>
<body>
<div id="map"></div>
<script>
  function boot() {
    const map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 5
    });

    let idleTimer = null;
    const pointCache   = new Map(); // p{id} -> Overlay
    const clusterCache = new Map(); // c{id} -> Overlay
    const hideAll = (cache) => cache.forEach(o => o.setMap(null));

    function notifyIdle() {
      const b = map.getBounds();
      const sw = b.getSouthWest();
      const ne = b.getNorthEast();
      const level = map.getLevel();
      window.flutter_inappwebview?.callHandler('onIdle', {
        west: sw.getLng(), south: sw.getLat(), east: ne.getLng(), north: ne.getLat(), level
      });
    }

    kakao.maps.event.addListener(map, 'idle', () => {
      if (idleTimer) clearTimeout(idleTimer);
      idleTimer = setTimeout(notifyIdle, 180);
    });

    window.renderNodes = function(nodes){
      hideAll(pointCache); hideAll(clusterCache);
      for (const n of nodes) {
        if (n.type === 'cluster') {
          const key = 'c'+n.id;
          let ov = clusterCache.get(key);
          const pos = new kakao.maps.LatLng(n.lat, n.lng);
          if (!ov) {
            const el = document.createElement('div');
            el.className = 'cluster-badge';
            el.textContent = String(n.count);
            el.addEventListener('click', () => {
              map.setLevel(Math.max(1, map.getLevel()-1), {anchor: pos});
              notifyIdle();
            });
            ov = new kakao.maps.CustomOverlay({ position: pos, content: el, yAnchor: .5, xAnchor: .5 });
            clusterCache.set(key, ov);
          } else {
            ov.setPosition(pos);
            ov.getContent().textContent = String(n.count);
          }
          ov.setMap(map);
        } else {
          const key = 'p'+n.id;
          let ov = pointCache.get(key);
          const pos = new kakao.maps.LatLng(n.lat, n.lng);
          if (!ov) {
            const el = document.createElement('div');
            el.className = 'avatar';
            if (n.profileUrl) { const img = document.createElement('img'); img.src = n.profileUrl; el.appendChild(img); }
            el.addEventListener('click', () => window.flutter_inappwebview?.callHandler('onMarkerTap', { id: n.id }));
            ov = new kakao.maps.CustomOverlay({ position: pos, content: el, yAnchor: .5, xAnchor: .5 });
            pointCache.set(key, ov);
          } else {
            ov.setPosition(pos);
          }
          ov.setMap(map);
        }
      }
    };

    window.moveTo = function(lat, lng, level){
      map.setLevel(level ?? map.getLevel());
      map.setCenter(new kakao.maps.LatLng(lat,lng));
      notifyIdle();
    };

    // 첫 렌더 요청
    notifyIdle();
  }

  // SDK 로드 완료 후 실행
  kakao.maps.load(() => {
    console.log('kakao loaded?', !!window.kakao);
    boot();
  });
</script>
</body>
</html>
